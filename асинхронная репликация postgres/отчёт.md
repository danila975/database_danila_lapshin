# источники и полезные ссылки

https://www.dmosk.ru/miniinstruktions.php?mini=postgresql-replication-docker

https://habr.com/ru/articles/310460/

# окружение

на компьютере, на котором произходила реплекация стаяла операционная система linux debian 12, docker и docker-compose.

# использованные технологии

для реплекации использовалась система контейнеризации docker и система сборки приложений из docker контейнеров docker-compose.

# поднятие контейнеров в docker-compose

dockercompose собирает приложение используя специальный compose файл, приложенный к этому отчёту. для запуска используется команда:

docker-compose up -d

данную команду нужно выполнять в папке, в которой лежит compose файл. она создаёт локальную сеть, к которой подключатся все контейнеры, которые создаются из этого файла и называет её по имени папки с compose файлом. например у меня это была папка base и сеть называлась base_default. default добавляется при создании сети автоматически. за создание сети отвечает ключ -d. так же либо создаются, либо, если уже существуют запускаются контейнеры, обозначенные в файле. в данном случае создаётся 1 контейнер для мастера и 2 контейнера для слэйвов.

# настройка мастера

для того, чтобы убедиться что контейнеры подключены к сети я использовал команду:Ж

docker network connect имя сети имя контейнера

если всё хорошо, она выведит то, что данный контейнер уже существует в сети.

с помощью команды:

docker exec -it имя контейнера bash

заходим в контейнер. ключ -it говорит докеру о том, что мы будем исполнять в нём команды, а слово bash обозначает язык, на котором мы это делаем. дальнейшая работа происходит как с клиентом postgresql
нам нужно создать столько пользователей с правами реплекации, сколько планируется слэйвов. дальше с помощью команды:

exit

выходим из контейнера, для этого понадобится исполнить её несколько раз. дальше переходим к конфигурационному файлу postgresql.conf по пути указанному в compose файле для мастера, для его редактирования я использовал стандартный редактор pluma и ищем и приводим к такому виду параметры:

wal_level = replica
max_wal_senders = 2
max_replication_slots = 2
hot_standby = on
hot_standby_feedback = on
* 
где

■ wal_level указывает, сколько информации записывается в WAL (журнал операций, который используется для репликации). Значение replica указывает на необходимость записывать только данные для поддержки архивирования WAL и репликации.

■ max_wal_senders — количество планируемых слейвов; 

■ max_replication_slots — максимальное число слотов репликации (данный параметр не нужен для postgresql 9.2 — с ним сервер не запустится); 

■ hot_standby — определяет, можно или нет подключаться к postgresql для выполнения запросов в процессе восстановления; 

■ hot_standby_feedback — определяет, будет или нет сервер slave сообщать мастеру о запросах, которые он выполняет.

командой:

docker network inspect имя сети | grep Subnet

смотрим адрес локальной сети. теперь нужно добавить в файл pg_hba.conf по пути из compose файла такую строку:

host    replication     all             адрес локальной сети          md5

данная строка обозначит то, что к мастеру может подключаться любой сетевой адрес. дальше с помощью команды:

docker restart имя контейнера

перезапускаем мастера и смотрим запусчен ли он с помощью команды:

docker ps

если всё хорошо переходим к настройке слэйва

# настройка слэйвов

для каждого из имеющихся слэйвов удаляем всё содержимое каталогов, записывающихся на host командой:

rm путь к файлу*

но не удаляем сами каталоги, для этого ставим в конце команды *

дальше копируем и настраеваем реплекацию на каждый слэв командой:

su - postgres -c "pg_basebackup --host=postgresql_01 --username=repluser --pgdata=/var/lib/postgresql/data --wal-method=stream --write-recovery-conf"

где postgresql_01 — наш мастер; /var/lib/postgresql/data — путь до каталога с данными слейва.

данная команда скопирует конфигурацию мастера на слэйв и настроит методы реплекации, в данном случае это wal-method=stream. данная команда выполняется внутри контейнера со слэйвом.

# проверка

заходим на мастера и создаём любую базу данных, дальше заходим на слэйвы и проверяем её наличие на них. если всё получилось, на слэйвах должна появиться созданная на мастере база.